<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Administrador</title>
    <style>
        /* ... (todo el CSS se mantiene igual) ... */
    </style>
</head>
<body>
    <div class="header">
        <div class="header-content">
            <h1>üõ°Ô∏è Dashboard Administrador</h1>
            <div>
                <span>Bienvenido, <strong><%= user.nickname %></strong></span>
                <a href="/logout" class="btn btn-danger" style="margin-left: 15px;">Cerrar Sesi√≥n</a>
            </div>
        </div>
    </div>

    <div class="container">
        <!-- Estad√≠sticas Globales -->
        <div class="admin-stats">
            <div class="stat-card">
                <h3>üìä Equipos Totales</h3>
                <div class="value"><%= Object.keys(grupos).length %></div>
                <div class="trend">
                    <% 
                    var equiposActivos = 0;
                    for (var grupo in grupos) {
                        if (grupos[grupo].started === 'y') equiposActivos++;
                    }
                    %>
                    <%= equiposActivos %> activos
                </div>
            </div>
            <div class="stat-card">
                <h3>‚úÖ Proyectos Completados</h3>
                <div class="value">12</div>
                <div class="trend">+3 este mes</div>
            </div>
            <div class="stat-card">
                <h3>‚ö†Ô∏è Impedimentos Activos</h3>
                <div class="value">8</div>
                <div class="trend">-2 vs semana anterior</div>
            </div>
            <div class="stat-card">
                <h3>üìà Velocidad Promedio</h3>
                <div class="value">21.5</div>
                <div class="trend">story points por sprint</div>
            </div>
            <div class="stat-card">
                <h3>üë• Desarrolladores Activos</h3>
                <div class="value">45</div>
                <div class="trend">en <%= Object.keys(grupos).length %> equipos</div>
            </div>
            <div class="stat-card">
                <h3>üéØ Satisfacci√≥n Promedio</h3>
                <div class="value">8.7/10</div>
                <div class="trend">+0.3 vs mes anterior</div>
            </div>
        </div>

        <!-- Alertas Cr√≠ticas -->
        <div class="alerts-section">
            <h3>üö® Alertas del Sistema</h3>
            <div class="alert alert-danger">
                <span>‚õî</span>
                <div>
                    <strong>Grupo2</strong> - Sprint retrasado 3 d√≠as. Impedimento cr√≠tico en dependencia externa.
                    <button class="btn btn-warning" style="margin-left: 10px; padding: 4px 8px; font-size: 0.8em;">Gestionar</button>
                </div>
            </div>
            <div class="alert alert-warning">
                <span>‚ö†Ô∏è</span>
                <div>
                    <strong>Grupo4</strong> - Velocidad del equipo 40% por debajo del promedio.
                    <button class="btn btn-info" style="margin-left: 10px; padding: 4px 8px; font-size: 0.8em;">Revisar</button>
                </div>
            </div>
            <div class="alert alert-info">
                <span>‚ÑπÔ∏è</span>
                <div>
                    <strong>Grupo1</strong> - Excelente performance. 120% de la velocidad esperada.
                </div>
            </div>
        </div>

        <!-- Acciones R√°pidas -->
        <div class="quick-actions">
            <h3>‚ö° Acciones R√°pidas</h3>
            <div class="action-buttons">
                <button class="btn btn-primary" onclick="openModal('createTeamModal')">
                    <span>‚ûï</span> Crear Equipo
                </button>
                <button class="btn btn-success" onclick="exportReport()">
                    <span>üìä</span> Exportar Reporte
                </button>
                <button class="btn btn-warning" onclick="openModal('backupModal')">
                    <span>üíæ</span> Backup Sistema
                </button>
                <button class="btn btn-info" onclick="openModal('settingsModal')">
                    <span>‚öôÔ∏è</span> Configuraci√≥n Global
                </button>
                <button class="btn btn-danger" onclick="openModal('alertsModal')">
                    <span>üö®</span> Gestionar Alertas
                </button>
            </div>
        </div>

        <!-- Navegaci√≥n por Pesta√±as -->
        <div class="tabs">
            <button class="tab active" onclick="showTab('teams')">üè¢ Equipos</button>
            <button class="tab" onclick="showTab('projects')">üöÄ Proyectos</button>
            <button class="tab" onclick="showTab('analytics')">üìà Anal√≠ticas</button>
            <button class="tab" onclick="showTab('users')">üë• Usuarios</button>
        </div>

        <!-- Contenido: Vista de Equipos -->
        <div id="teams-tab" class="tab-content active">
            <div class="teams-overview">
                <% 
                for (var grupo in grupos) {
                    var equipo = grupos[grupo];
                    var estaActivo = equipo.started && equipo.started === 'y';
                    
                    var totalHU = 0;
                    if (equipo.GenT && equipo.GenT.productBacklog) totalHU += equipo.GenT.productBacklog.length;
                    if (equipo.Proy && equipo.Proy.productBacklog) totalHU += equipo.Proy.productBacklog.length;
                    if (equipo.Proy2 && equipo.Proy2.productBacklog) totalHU += equipo.Proy2.productBacklog.length;
                    
                    var velocidadPromedio = Math.floor(Math.random() * 10) + 15;
                %>
                    <div class="team-card">
                        <div class="team-header">
                            <h3>üè¢ <%= grupo %></h3>
                            <span class="team-status <%= estaActivo ? 'status-active' : 'status-inactive' %>">
                                <%= estaActivo ? 'üü¢ Activo' : 'üî¥ Inactivo' %>
                            </span>
                        </div>
                        
                        <% if (estaActivo) { %>
                            <div class="team-metrics">
                                <div class="metric">
                                    <div class="metric-value"><%= velocidadPromedio %></div>
                                    <div class="metric-label">Velocidad</div>
                                </div>
                                <div class="metric">
                                    <div class="metric-value"><%= equipo.GenT && equipo.GenT.sprintActual ? equipo.GenT.sprintActual : 1 %></div>
                                    <div class="metric-label">Sprint</div>
                                </div>
                                <div class="metric">
                                    <div class="metric-value"><%= totalHU %></div>
                                    <div class="metric-label">Total HU</div>
                                </div>
                            </div>
                            
                            <div class="project-details">
                                <% if (equipo.GenT) { %>
                                    <div class="project-card gent">
                                        <h4>üéØ Generaci√≥n T</h4>
                                        <p>Sprint <%= equipo.GenT.sprintActual || 1 %> | <%= equipo['duracion-sprint-gent'] %>sem</p>
                                        <div class="progress-bar">
                                            <div class="progress-fill" style="width: <%= Math.floor(Math.random() * 60) + 30 %>%"></div>
                                        </div>
                                        <p><small>Backlog: <%= equipo.GenT.productBacklog ? equipo.GenT.productBacklog.length : 0 %> items</small></p>
                                    </div>
                                <% } %>
                                
                                <% if (equipo.Proy) { %>
                                    <div class="project-card proy">
                                        <h4>üöÄ Proyecto</h4>
                                        <p>Sprint <%= equipo.Proy.sprintActual || 1 %> | <%= equipo['duracion-sprint-proyecto'] %>sem</p>
                                        <div class="progress-bar">
                                            <div class="progress-fill" style="width: <%= Math.floor(Math.random() * 60) + 25 %>%"></div>
                                        </div>
                                        <p><small>Backlog: <%= equipo.Proy.productBacklog ? equipo.Proy.productBacklog.length : 0 %> items</small></p>
                                    </div>
                                <% } %>
                                
                                <% if (equipo.Proy2) { %>
                                    <div class="project-card proy2">
                                        <h4>‚≠ê Proyecto 2</h4>
                                        <p>Sprint <%= equipo.Proy2.sprintActual || 1 %> | <%= equipo['duracion-sprint-proyecto2'] %>sem</p>
                                        <div class="progress-bar">
                                            <div class="progress-fill" style="width: <%= Math.floor(Math.random() * 50) + 20 %>%"></div>
                                        </div>
                                        <p><small>Backlog: <%= equipo.Proy2.productBacklog ? equipo.Proy2.productBacklog.length : 0 %> items</small></p>
                                    </div>
                                <% } %>
                            </div>
                            
                            <div style="margin-top: 15px; display: flex; gap: 8px;">
                                <button class="btn btn-primary" onclick="viewTeamDetails('<%= grupo %>')">üëÅÔ∏è Ver Detalle</button>
                                <button class="btn btn-info" onclick="openTeamSettings('<%= grupo %>')">‚öôÔ∏è Configurar</button>
                                <button class="btn btn-warning" onclick="downloadTeamReport('<%= grupo %>')">üìä Reporte</button>
                            </div>
                        <% } else { %>
                            <p style="color: #666; margin: 15px 0;">El equipo a√∫n no ha iniciado sus proyectos.</p>
                            <button class="btn btn-success" onclick="initializeTeam('<%= grupo %>')">üöÄ Inicializar Equipo</button>
                        <% } %>
                    </div>
                <% } %>
            </div>
        </div>

        <!-- Contenido: Vista de Proyectos -->
        <div id="projects-tab" class="tab-content">
            <div class="detailed-view">
                <h3>üöÄ An√°lisis Global de Proyectos</h3>
                
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-top: 20px;">
                    <div class="project-card gent">
                        <h4>üéØ Generaci√≥n T (Todos los equipos)</h4>
                        <div class="metric">
                            <div class="metric-value">
                                <%
                                var countGenT = 0;
                                for (var g in grupos) {
                                    if (grupos[g].GenT) countGenT++;
                                }
                                %>
                                <%= countGenT %>
                            </div>
                            <div class="metric-label">equipos participando</div>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: 68%"></div>
                        </div>
                        <p><small>Progreso promedio: 68%</small></p>
                    </div>
                    
                    <div class="project-card proy">
                        <h4>üöÄ Proyectos Principales</h4>
                        <div class="metric">
                            <div class="metric-value">
                                <%
                                var countProy = 0;
                                for (var g in grupos) {
                                    if (grupos[g].Proy) countProy++;
                                }
                                %>
                                <%= countProy %>
                            </div>
                            <div class="metric-label">proyectos activos</div>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: 45%"></div>
                        </div>
                        <p><small>Progreso promedio: 45%</small></p>
                    </div>
                    
                    <div class="project-card proy2">
                        <h4>‚≠ê Proyectos Secundarios</h4>
                        <div class="metric">
                            <div class="metric-value">
                                <%
                                var countProy2 = 0;
                                for (var g in grupos) {
                                    if (grupos[g].Proy2) countProy2++;
                                }
                                %>
                                <%= countProy2 %>
                            </div>
                            <div class="metric-label">proyectos avanzados</div>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: 25%"></div>
                        </div>
                        <p><small>Progreso promedio: 25%</small></p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Contenido: Analytics -->
        <div id="analytics-tab" class="tab-content">
            <div class="detailed-view">
                <h3>üìà Anal√≠ticas del Sistema</h3>
                
                <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 20px; margin-top: 20px;">
                    <div>
                        <h4>üìä Rendimiento por Equipo</h4>
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Equipo</th>
                                    <th>Velocidad</th>
                                    <th>Burndown</th>
                                    <th>Satisfacci√≥n</th>
                                    <th>Estado</th>
                                </tr>
                            </thead>
                            <tbody>
                                <% 
                                for (var grupo in grupos) {
                                    var equipo = grupos[grupo];
                                    if (equipo.started === 'y') {
                                %>
                                    <tr>
                                        <td><strong><%= grupo %></strong></td>
                                        <td><%= Math.floor(Math.random() * 10) + 15 %> pts</td>
                                        <td>
                                            <div class="progress-bar" style="height: 6px;">
                                                <% var progressWidth = Math.floor(Math.random() * 60) + 30; %>
                                                <div class="progress-fill" style="width: <%= progressWidth %>%;"></div>
                                            </div>
                                        </td>
                                        <td><%= (Math.random() * 2 + 8).toFixed(1) %>/10</td>
                                        <td><span class="status-badge status-active">‚úÖ Activo</span></td>
                                    </tr>
                                <% 
                                    }
                                }
                                %>
                            </tbody>
                        </table>
                    </div>
                    
                    <div>
                        <h4>üéØ KPIs Clave</h4>
                        <div style="display: flex; flex-direction: column; gap: 15px;">
                            <div class="metric" style="text-align: left; padding: 20px;">
                                <div style="display: flex; justify-content: between;">
                                    <span>Eficiencia Global</span>
                                    <strong>89%</strong>
                                </div>
                                <div class="progress-bar">
                                    <div class="progress-fill" style="width: 89%"></div>
                                </div>
                            </div>
                            
                            <div class="metric" style="text-align: left; padding: 20px;">
                                <div style="display: flex; justify-content: between;">
                                    <span>Calidad Promedio</span>
                                    <strong>94%</strong>
                                </div>
                                <div class="progress-bar">
                                    <div class="progress-fill" style="width: 94%"></div>
                                </div>
                            </div>
                            
                            <div class="metric" style="text-align: left; padding: 20px;">
                                <div style="display: flex; justify-content: between;">
                                    <span>Cumplimiento Sprints</span>
                                    <strong>76%</strong>
                                </div>
                                <div class="progress-bar">
                                    <div class="progress-fill" style="width: 76%"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Contenido: Usuarios -->
        <div id="users-tab" class="tab-content">
            <div class="detailed-view">
                <h3>üë• Gesti√≥n de Usuarios</h3>
                <div style="margin: 20px 0;">
                    <button class="btn btn-primary" onclick="openModal('addUserModal')">‚ûï A√±adir Usuario</button>
                    <button class="btn btn-info" onclick="exportUsers()">üìã Exportar Usuarios</button>
                </div>
                
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Usuario</th>
                            <th>Equipo</th>
                            <th>Rol</th>
                            <th>√öltimo Acceso</th>
                            <th>Estado</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Sample user data -->
                        <tr>
                            <td>Juan P√©rez</td>
                            <td>Grupo1</td>
                            <td>Desarrollador</td>
                            <td>Hace 2 horas</td>
                            <td><span class="status-badge status-active">üü¢ Activo</span></td>
                            <td>
                                <button class="btn btn-info" style="padding: 4px 8px; font-size: 0.8em;">Editar</button>
                                <button class="btn btn-warning" style="padding: 4px 8px; font-size: 0.8em;">Suspender</button>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Modales -->
    <div id="createTeamModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('createTeamModal')">&times;</span>
            <h2>‚ûï Crear Nuevo Equipo</h2>
            <form id="createTeamForm">
                <div style="margin-bottom: 15px;">
                    <label>Nombre del Equipo:</label>
                    <input type="text" id="teamName" required placeholder="GrupoX">
                </div>
                <div style="margin-bottom: 15px;">
                    <label>N√∫mero de Proyectos:</label>
                    <select id="projectCount">
                        <option value="2">2 proyectos (GenT + Proyecto)</option>
                        <option value="3">3 proyectos (GenT + Proyecto + Proyecto2)</option>
                    </select>
                </div>
                <button type="submit" class="btn btn-success">Crear Equipo</button>
            </form>
        </div>
    </div>

    <script>
        function showTab(tabName) {
            // Hide all tab contents
            var contents = document.querySelectorAll('.tab-content');
            for (var i = 0; i < contents.length; i++) {
                contents[i].classList.remove('active');
            }
            
            // Remove active from all tabs
            var tabs = document.querySelectorAll('.tab');
            for (var i = 0; i < tabs.length; i++) {
                tabs[i].classList.remove('active');
            }
            
            // Show selected tab
            document.getElementById(tabName + '-tab').classList.add('active');
            event.target.classList.add('active');
        }

        function openModal(modalId) {
            document.getElementById(modalId).style.display = 'block';
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        function viewTeamDetails(teamName) {
            alert('Ver detalles del ' + teamName);
            // Implement detailed view
        }

        function openTeamSettings(teamName) {
            alert('Configuraci√≥n del ' + teamName);
            // Implement team settings
        }

        function downloadTeamReport(teamName) {
            alert('Descargando reporte del ' + teamName);
            // Implement report download
        }

        function initializeTeam(teamName) {
            if (confirm('¬øInicializar proyectos para ' + teamName + '?')) {
                fetch('/api/initialize-team', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ team: teamName })
                })
                .then(function(response) { return response.json(); })
                .then(function(data) {
                    if (data.success) {
                        location.reload();
                    } else {
                        alert('Error: ' + data.message);
                    }
                });
            }
        }

        function exportReport() {
            alert('Exportando reporte global...');
            // Implement global report export
        }

        function exportUsers() {
            alert('Exportando lista de usuarios...');
            // Implement user export
        }

        // Auto-refresh every 2 minutes
        setInterval(function() {
            fetch('/api/admin/status')
            .then(function(response) { return response.json(); })
            .then(function(data) {
                // Update metrics without full page reload
                console.log('Status updated');
            });
        }, 120000);

        // Close modal when clicking outside
        window.onclick = function(event) {
            var modals = document.querySelectorAll('.modal');
            for (var i = 0; i < modals.length; i++) {
                if (event.target === modals[i]) {
                    modals[i].style.display = 'none';
                }
            }
        }

        // Form submissions
        document.getElementById('createTeamForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            var teamData = {
                name: document.getElementById('teamName').value,
                projects: document.getElementById('projectCount').value
            };

            fetch('/api/admin/create-team', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(teamData)
            })
            .then(function(response) { return response.json(); })
            .then(function(data) {
                if (data.success) {
                    location.reload();
                } else {
                    alert('Error: ' + data.message);
                }
            });

            closeModal('createTeamModal');
        });
    </script>
</body>
</html>