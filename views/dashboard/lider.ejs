<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Líder - DARDITO</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="bg-gray-50">
    <!-- Navigation Header -->
    <nav class="bg-white shadow-sm border-b">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex items-center">
                    <h1 class="text-xl font-semibold text-gray-900">DARDITO - Líder de <%= grupo %></h1>
                </div>
                <div class="flex items-center space-x-4">
                    <span class="text-sm text-gray-600">Bienvenido, <%= user.nickname %></span>
                    <a href="/logout" class="bg-red-600 hover:bg-red-700 text-white px-3 py-2 rounded-md text-sm font-medium">
                        Cerrar Sesión
                    </a>
                </div>
            </div>
        </div>
    </nav>

    <!-- Tabs de Navegación -->
    <div class="bg-white border-b border-gray-200">
        <nav class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 -mb-px flex space-x-8">
            <button onclick="cambiarTab('resumen')" id="tab-resumen" 
                    class="tab-button py-2 px-1 border-b-2 border-blue-500 font-medium text-sm text-blue-600">
                Resumen General
            </button>
            <% if (datos.GenT) { %>
            <button onclick="cambiarTab('gent')" id="tab-gent" 
                    class="tab-button py-2 px-1 border-b-2 border-transparent font-medium text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300">
                Generación T
            </button>
            <% } %>
            <% if (datos.Proy) { %>
            <button onclick="cambiarTab('proy')" id="tab-proy" 
                    class="tab-button py-2 px-1 border-b-2 border-transparent font-medium text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300">
                Proyecto Principal
            </button>
            <% } %>
            <% if (datos.Proy2) { %>
            <button onclick="cambiarTab('proy2')" id="tab-proy2" 
                    class="tab-button py-2 px-1 border-b-2 border-transparent font-medium text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300">
                Proyecto Secundario
            </button>
            <% } %>
            <button onclick="cambiarTab('equipo')" id="tab-equipo" 
                    class="tab-button py-2 px-1 border-b-2 border-transparent font-medium text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300">
                Gestión de Equipo
            </button>
        </nav>
    </div>

    <div class="max-w-7xl mx-auto py-6 sm:px-6 lg:px-8">
        <!-- Tab: Resumen General -->
        <div id="content-resumen" class="tab-content">
            <!-- Estadísticas Generales -->
            <div class="grid grid-cols-1 gap-5 sm:grid-cols-2 lg:grid-cols-4 mb-8">
                <div class="bg-white overflow-hidden shadow rounded-lg">
                    <div class="p-5">
                        <div class="flex items-center">
                            <div class="flex-shrink-0">
                                <div class="w-8 h-8 bg-blue-600 rounded-md flex items-center justify-center">
                                    <span class="text-white text-sm font-semibold">H</span>
                                </div>
                            </div>
                            <div class="ml-5 w-0 flex-1">
                                <dl>
                                    <dt class="text-sm font-medium text-gray-500 truncate">Total Historias</dt>
                                    <dd class="text-lg font-medium text-gray-900"><%= estadisticas.resumenGeneral.totalHistorias || 0 %></dd>
                                </dl>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="bg-white overflow-hidden shadow rounded-lg">
                    <div class="p-5">
                        <div class="flex items-center">
                            <div class="flex-shrink-0">
                                <div class="w-8 h-8 bg-green-600 rounded-md flex items-center justify-center">
                                    <span class="text-white text-sm font-semibold">SP</span>
                                </div>
                            </div>
                            <div class="ml-5 w-0 flex-1">
                                <dl>
                                    <dt class="text-sm font-medium text-gray-500 truncate">Story Points</dt>
                                    <dd class="text-lg font-medium text-gray-900"><%= estadisticas.resumenGeneral.totalStoryPoints || 0 %></dd>
                                </dl>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="bg-white overflow-hidden shadow rounded-lg">
                    <div class="p-5">
                        <div class="flex items-center">
                            <div class="flex-shrink-0">
                                <div class="w-8 h-8 bg-yellow-600 rounded-md flex items-center justify-center">
                                    <span class="text-white text-sm font-semibold">T</span>
                                </div>
                            </div>
                            <div class="ml-5 w-0 flex-1">
                                <dl>
                                    <dt class="text-sm font-medium text-gray-500 truncate">Total Tareas</dt>
                                    <dd class="text-lg font-medium text-gray-900"><%= estadisticas.resumenGeneral.totalTareas || 0 %></dd>
                                </dl>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="bg-white overflow-hidden shadow rounded-lg">
                    <div class="p-5">
                        <div class="flex items-center">
                            <div class="flex-shrink-0">
                                <div class="w-8 h-8 bg-purple-600 rounded-md flex items-center justify-center">
                                    <span class="text-white text-sm font-semibold">%</span>
                                </div>
                            </div>
                            <div class="ml-5 w-0 flex-1">
                                <dl>
                                    <dt class="text-sm font-medium text-gray-500 truncate">Completación</dt>
                                    <dd class="text-lg font-medium text-gray-900"><%= estadisticas.resumenGeneral.porcentajeCompletacion || 0 %>%</dd>
                                </dl>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Progreso por Proyecto -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
                <% ['GenT', 'Proy', 'Proy2'].forEach(proyecto => { %>
                <% if (datos[proyecto]) { %>
                <div class="bg-white shadow rounded-lg p-6">
                    <h3 class="text-lg font-medium text-gray-900 mb-4">
                        <%= proyecto === 'GenT' ? 'Generación T' : proyecto === 'Proy' ? 'Proyecto Principal' : 'Proyecto Secundario' %>
                    </h3>
                    <% if (estadisticas.proyectos && estadisticas.proyectos[proyecto]) { %>
                    <div class="space-y-4">
                        <div>
                            <div class="flex justify-between text-sm font-medium">
                                <span>Historias Completadas</span>
                                <span><%= estadisticas.proyectos[proyecto].historiasCompletadas || 0 %>/<%= estadisticas.proyectos[proyecto].totalHistorias || 0 %></span>
                            </div>
                            <div class="mt-1 bg-gray-200 rounded-full h-2">
                                <div class="bg-green-600 h-2 rounded-full" 
                                     style="width: <%= estadisticas.proyectos[proyecto].porcentajeHistorias || 0 %>%"></div>
                            </div>
                        </div>
                        <div>
                            <div class="flex justify-between text-sm font-medium">
                                <span>Tareas del Sprint</span>
                                <span><%= estadisticas.proyectos[proyecto].tareasCompletadas || 0 %>/<%= estadisticas.proyectos[proyecto].totalTareas || 0 %></span>
                            </div>
                            <div class="mt-1 bg-gray-200 rounded-full h-2">
                                <div class="bg-blue-600 h-2 rounded-full" 
                                     style="width: <%= estadisticas.proyectos[proyecto].porcentajeTareas || 0 %>%"></div>
                            </div>
                        </div>
                    </div>
                    <% } %>
                </div>
                <% } %>
                <% }) %>
            </div>

            <!-- Alertas y Recomendaciones -->
            <% if (estadisticas.alertas && estadisticas.alertas.length > 0) { %>
            <div class="bg-white shadow rounded-lg p-6 mb-8">
                <h3 class="text-lg font-medium text-gray-900 mb-4">Alertas del Sistema</h3>
                <div class="space-y-3">
                    <% estadisticas.alertas.forEach(alerta => { %>
                    <div class="flex p-4 rounded-md <%= alerta.tipo === 'warning' ? 'bg-yellow-50' : alerta.tipo === 'success' ? 'bg-green-50' : 'bg-blue-50' %>">
                        <div class="flex-shrink-0">
                            <% if (alerta.tipo === 'warning') { %>
                            <div class="h-5 w-5 text-yellow-400">⚠</div>
                            <% } else if (alerta.tipo === 'success') { %>
                            <div class="h-5 w-5 text-green-400">✓</div>
                            <% } else { %>
                            <div class="h-5 w-5 text-blue-400">ⓘ</div>
                            <% } %>
                        </div>
                        <div class="ml-3">
                            <p class="text-sm font-medium <%= alerta.tipo === 'warning' ? 'text-yellow-800' : alerta.tipo === 'success' ? 'text-green-800' : 'text-blue-800' %>">
                                <%= alerta.mensaje %>
                            </p>
                            <p class="mt-1 text-sm <%= alerta.tipo === 'warning' ? 'text-yellow-700' : alerta.tipo === 'success' ? 'text-green-700' : 'text-blue-700' %>">
                                <%= alerta.accionRecomendada %>
                            </p>
                        </div>
                    </div>
                    <% }) %>
                </div>
            </div>
            <% } %>
        </div>

        <!-- Tabs de Proyectos (GenT, Proy, Proy2) -->
        <% ['GenT', 'Proy', 'Proy2'].forEach(proyecto => { %>
        <% if (datos[proyecto]) { %>
        <div id="content-<%= proyecto.toLowerCase() %>" class="tab-content hidden">
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <!-- Product Backlog -->
                <div class="lg:col-span-2">
                    <div class="bg-white shadow rounded-lg">
                        <div class="px-4 py-5 sm:px-6 flex justify-between items-center">
                            <h3 class="text-lg leading-6 font-medium text-gray-900">Product Backlog</h3>
                            <button onclick="crearHistoria('<%= proyecto %>')" 
                                    class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-md text-sm font-medium">
                                Nueva Historia
                            </button>
                        </div>
                        <div class="border-t border-gray-200">
                            <ul id="backlog-<%= proyecto.toLowerCase() %>" class="divide-y divide-gray-200">
                                <!-- Las historias se cargan dinámicamente -->
                            </ul>
                        </div>
                    </div>
                </div>

                <!-- Panel de Gestión -->
                <div class="space-y-6">
                    <!-- Información del Sprint Actual -->
                    <div class="bg-white shadow rounded-lg p-6">
                        <h3 class="text-lg font-medium text-gray-900 mb-4">Sprint Actual</h3>
                        <div class="space-y-2">
                            <p class="text-sm text-gray-600">Sprint #<%= datos[proyecto].sprintActual || '1' %></p>
                            <% if (datos[proyecto]['sprint' + (datos[proyecto].sprintActual || '1')]) { %>
                            <% const sprint = datos[proyecto]['sprint' + (datos[proyecto].sprintActual || '1')] %>
                            <p class="text-sm text-gray-600">
                                Inicio: <%= sprint.fechaIni ? sprint.fechaIni.join('/') : 'N/A' %>
                            </p>
                            <p class="text-sm text-gray-600">
                                Fin: <%= sprint.fechaFin ? sprint.fechaFin.join('/') : 'N/A' %>
                            </p>
                            <% } %>
                        </div>
                        <div class="mt-4">
                            <button onclick="gestionarSprint('<%= proyecto %>')" 
                                    class="w-full bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-md text-sm font-medium">
                                Gestionar Sprint
                            </button>
                        </div>
                    </div>

                    <!-- Acciones Rápidas -->
                    <div class="bg-white shadow rounded-lg p-6">
                        <h3 class="text-lg font-medium text-gray-900 mb-4">Acciones Rápidas</h3>
                        <div class="space-y-3">
                            <button onclick="verTareas('<%= proyecto %>')" 
                                    class="w-full bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-md text-sm font-medium">
                                Ver Tareas
                            </button>
                            <button onclick="crearTarea('<%= proyecto %>')" 
                                    class="w-full bg-yellow-600 hover:bg-yellow-700 text-white px-4 py-2 rounded-md text-sm font-medium">
                                Nueva Tarea
                            </button>
                            <button onclick="verEstadisticas('<%= proyecto %>')" 
                                    class="w-full bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-md text-sm font-medium">
                                Estadísticas
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <% } %>
        <% }) %>

        <!-- Tab: Gestión de Equipo -->
        <div id="content-equipo" class="tab-content hidden">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- Lista de Miembros -->
                <div class="bg-white shadow rounded-lg">
                    <div class="px-4 py-5 sm:px-6">
                        <h3 class="text-lg leading-6 font-medium text-gray-900">Miembros del Equipo</h3>
                    </div>
                    <div class="border-t border-gray-200">
                        <ul class="divide-y divide-gray-200">
                            <% miembrosEquipo.forEach(miembro => { %>
                            <li class="px-4 py-4">
                                <div class="flex items-center justify-between">
                                    <div class="flex items-center">
                                        <div class="flex-shrink-0 h-10 w-10">
                                            <div class="h-10 w-10 rounded-full bg-gray-300 flex items-center justify-center">
                                                <span class="text-sm font-medium text-gray-700">
                                                    <%= miembro.nickname.charAt(0).toUpperCase() %>
                                                </span>
                                            </div>
                                        </div>
                                        <div class="ml-4">
                                            <div class="text-sm font-medium text-gray-900"><%= miembro.nickname %></div>
                                            <div class="text-sm text-gray-500 capitalize"><%= miembro.rol %></div>
                                        </div>
                                    </div>
                                    <div class="text-right">
                                        <% if (miembro.stats && miembro.stats[0] > 0) { %>
                                        <div class="text-sm text-gray-900">
                                            <%= (miembro.stats[0] / 3600).toFixed(1) %>h en llamadas
                                        </div>
                                        <% } %>
                                        <div class="text-sm text-gray-500">
                                            Tareas: <%= miembro.stats && miembro.stats[1] ? miembro.stats[1] : 0 %>
                                        </div>
                                    </div>
                                </div>
                            </li>
                            <% }) %>
                        </ul>
                    </div>
                </div>

                <!-- Estadísticas del Equipo -->
                <div class="bg-white shadow rounded-lg p-6">
                    <h3 class="text-lg font-medium text-gray-900 mb-4">Rendimiento del Equipo</h3>
                    <div class="space-y-4">
                        <div class="flex justify-between items-center">
                            <span class="text-sm font-medium text-gray-700">Productividad Promedio</span>
                            <span class="text-sm text-gray-900">
                                <% 
                                let totalTareas = 0;
                                let totalCompletadas = 0;
                                miembrosEquipo.forEach(m => {
                                    totalTareas += m.stats && m.stats[1] ? m.stats[1] : 0;
                                    totalCompletadas += m.stats && m.stats[2] ? m.stats[2] : 0;
                                });
                                const productividad = totalTareas > 0 ? Math.round((totalCompletadas / totalTareas) * 100) : 0;
                                %>
                                <%= productividad %>%
                            </span>
                        </div>
                        <div class="bg-gray-200 rounded-full h-2">
                            <div class="bg-green-600 h-2 rounded-full" style="width: <%= productividad %>%"></div>
                        </div>
                    </div>
                    
                    <div class="mt-6">
                        <button onclick="generarReporteEquipo()" 
                                class="w-full bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-md text-sm font-medium">
                            Generar Reporte
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modales -->
    <!-- Modal para crear Historia de Usuario -->
    <div id="modal-historia" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
        <div class="relative top-20 mx-auto p-5 border w-11/12 max-w-lg shadow-lg rounded-md bg-white">
            <div class="mt-3">
                <h3 class="text-lg font-medium text-gray-900 mb-4">Nueva Historia de Usuario</h3>
                <form id="form-historia" class="space-y-4">
                    <input type="hidden" id="historia-proyecto" value="">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Como</label>
                        <input type="text" id="historia-como" required 
                               class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Quiero</label>
                        <input type="text" id="historia-quiero" required 
                               class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Para</label>
                        <input type="text" id="historia-para" required 
                               class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Criterios de Aceptación</label>
                        <textarea id="historia-criterios" rows="3" 
                                  class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500"></textarea>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Prioridad</label>
                            <select id="historia-prioridad" 
                                    class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                                <option value="ALTA">Alta</option>
                                <option value="MEDIA">Media</option>
                                <option value="BAJA">Baja</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Story Points</label>
                            <input type="number" id="historia-points" min="1" max="21" value="3" 
                                   class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                        </div>
                    </div>
                    <div class="flex justify-end space-x-3 mt-6">
                        <button type="button" onclick="cerrarModal('modal-historia')" 
                                class="bg-gray-300 hover:bg-gray-400 text-gray-800 px-4 py-2 rounded-md text-sm font-medium">
                            Cancelar
                        </button>
                        <button type="submit" 
                                class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-md text-sm font-medium">
                            Crear Historia
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        let tabActual = 'resumen';

        // Función para cambiar tabs
        function cambiarTab(tab) {
            // Ocultar contenido actual
            document.getElementById(`content-${tabActual}`).classList.add('hidden');
            document.getElementById(`tab-${tabActual}`).classList.remove('border-blue-500', 'text-blue-600');
            document.getElementById(`tab-${tabActual}`).classList.add('border-transparent', 'text-gray-500');

            // Mostrar nuevo contenido
            document.getElementById(`content-${tab}`).classList.remove('hidden');
            document.getElementById(`tab-${tab}`).classList.add('border-blue-500', 'text-blue-600');
            document.getElementById(`tab-${tab}`).classList.remove('border-transparent', 'text-gray-500');

            tabActual = tab;

            // Cargar contenido específico del tab
            if (tab !== 'resumen' && tab !== 'equipo') {
                cargarProductBacklog(tab.toUpperCase());
            }
        }

        // Función para cargar Product Backlog
        async function cargarProductBacklog(proyecto) {
            try {
                const response = await fetch(`/api/product-backlog/<%= grupo %>/${proyecto}`);
                const data = await response.json();
                
                const container = document.getElementById(`backlog-${proyecto.toLowerCase()}`);
                container.innerHTML = '';

                if (data.productBacklog && data.productBacklog.length > 0) {
                    data.productBacklog.forEach(historia => {
                        const li = document.createElement('li');
                        li.className = 'px-4 py-4';
                        li.innerHTML = `
                            <div class="flex items-center justify-between">
                                <div class="flex-1">
                                    <div class="flex items-center">
                                        <div class="text-sm font-medium text-gray-900">
                                            ${historia[1]} - ${historia[2]}
                                        </div>
                                        <span class="ml-2 inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${
                                            historia[5] === 'ALTA' ? 'bg-red-100 text-red-800' :
                                            historia[5] === 'MEDIA' ? 'bg-yellow-100 text-yellow-800' :
                                            'bg-green-100 text-green-800'
                                        }">
                                            ${historia[5]}
                                        </span>
                                        <span class="ml-2 text-xs text-gray-500">
                                            ${historia[6]} SP
                                        </span>
                                    </div>
                                    <div class="text-sm text-gray-500 mt-1">
                                        Para: ${historia[3]}
                                    </div>
                                </div>
                                <div class="flex items-center space-x-2">
                                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${
                                        historia[7] === 'COMPLETADO' ? 'bg-green-100 text-green-800' :
                                        historia[7] === 'EN_PROCESO' ? 'bg-blue-100 text-blue-800' :
                                        historia[7] === 'EN_SPRINT' ? 'bg-purple-100 text-purple-800' :
                                        'bg-gray-100 text-gray-800'
                                    }">
                                        ${historia[7].replace('_', ' ')}
                                    </span>
                                    <button onclick="editarHistoria('${proyecto}', '${historia[0]}')" 
                                            class="text-indigo-600 hover:text-indigo-900 text-sm font-medium">
                                        Editar
                                    </button>
                                </div>
                            </div>
                        `;
                        container.appendChild(li);
                    });
                } else {
                    container.innerHTML = '<li class="px-4 py-4 text-center text-gray-500">No hay historias de usuario</li>';
                }
            } catch (error) {
                console.error('Error cargando backlog:', error);
            }
        }

        // Función para crear nueva historia
        function crearHistoria(proyecto) {
            document.getElementById('historia-proyecto').value = proyecto;
            document.getElementById('modal-historia').classList.remove('hidden');
        }

        // Función para cerrar modal
        function cerrarModal(modalId) {
            document.getElementById(modalId).classList.add('hidden');
        }

        // Función para gestionar sprint
        function gestionarSprint(proyecto) {
            window.location.href = `/proyecto/${proyecto}`;
        }

        // Función para ver tareas
        async function verTareas(proyecto) {
            try {
                const sprintActual = '<%= datos.GenT ? datos.GenT.sprintActual : "1" %>';
                const response = await fetch(`/api/tareas/<%= grupo %>/${proyecto}/${sprintActual}`);
                const data = await response.json();
                
                // Mostrar tareas en modal o nueva página
                console.log('Tareas:', data);
                // Implementar vista de tareas
            } catch (error) {
                console.error('Error cargando tareas:', error);
            }
        }

        // Función para crear nueva tarea
        function crearTarea(proyecto) {
            // Implementar modal de creación de tareas
            alert(`Crear nueva tarea para ${proyecto}`);
        }

        // Función para ver estadísticas
        async function verEstadisticas(proyecto) {
            try {
                const response = await fetch(`/api/estadisticas/<%= grupo %>/${proyecto}`);
                const data = await response.json();
                
                // Mostrar estadísticas detalladas
                console.log('Estadísticas:', data);
                // Implementar vista de estadísticas
            } catch (error) {
                console.error('Error cargando estadísticas:', error);
            }
        }

        // Función para generar reporte del equipo
        async function generarReporteEquipo() {
            try {
                const response = await fetch(`/api/reportes/productividad/<%= grupo %>`);
                const data = await response.json();
                
                // Mostrar o descargar reporte
                console.log('Reporte:', data);
                alert('Reporte generado correctamente');
            } catch (error) {
                console.error('Error generando reporte:', error);
            }
        }

        // Manejador del formulario de historia
        document.getElementById('form-historia').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const proyecto = document.getElementById('historia-proyecto').value;
            const data = {
                como: document.getElementById('historia-como').value,
                quiero: document.getElementById('historia-quiero').value,
                para: document.getElementById('historia-para').value,
                criterio_aceptacion: document.getElementById('historia-criterios').value,
                prioridad: document.getElementById('historia-prioridad').value,
                history_points: parseInt(document.getElementById('historia-points').value)
            };

            try {
                const response = await fetch(`/api/product-backlog/<%= grupo %>/${proyecto}/historia`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });

                if (response.ok) {
                    cerrarModal('modal-historia');
                    document.getElementById('form-historia').reset();
                    // Recargar backlog
                    cargarProductBacklog(proyecto);
                    alert('Historia creada correctamente');
                } else {
                    throw new Error('Error al crear historia');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error al crear la historia');
            }
        });

        // Cargar contenido inicial
        document.addEventListener('DOMContentLoaded', () => {
            // Cargar datos iniciales si es necesario
        });
    </script>
</body>
</html>