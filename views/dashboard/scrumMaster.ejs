<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Scrum Master - Dardito</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-900 text-gray-100 min-h-screen">
    <!-- Header medio feo pero funcional -->
    <header class="bg-gray-800 border-b-2 border-gray-700 p-4">
        <div class="container mx-auto flex justify-between items-center">
            <div>
                <h1 class="text-xl font-bold text-purple-400">Dashboard Scrum Master</h1>
                <p class="text-sm text-gray-300">
                    <span class="font-semibold"><%= user.nickname %></span> - 
                    <span class="bg-purple-700 px-2 py-1 rounded text-xs"><%= user.rol %></span> - 
                    <span class="bg-blue-700 px-2 py-1 rounded text-xs"><%= grupo %></span>
                </p>
            </div>
            <button onclick="window.location.href='/logout'" class="bg-red-600 hover:bg-red-700 px-4 py-2 rounded text-sm border border-red-500">
                Salir
            </button>
        </div>
    </header>

    <div class="container mx-auto px-4 py-6">
        <!-- Navegaci√≥n de proyectos -->
        <div class="mb-6">
            <div class="flex gap-2 flex-wrap">
                <button onclick="cambiarProyecto('GenT')" id="btn-GenT" class="bg-purple-700 hover:bg-purple-800 px-4 py-2 rounded border border-purple-600 text-sm font-semibold">
                    Generaci√≥n T
                </button>
                <button onclick="cambiarProyecto('Proy')" id="btn-Proy" class="bg-blue-700 hover:bg-blue-800 px-4 py-2 rounded border border-blue-600 text-sm font-semibold">
                    Proyecto
                </button>
                <% if (datos.Proy2) { %>
                <button onclick="cambiarProyecto('Proy2')" id="btn-Proy2" class="bg-green-700 hover:bg-green-800 px-4 py-2 rounded border border-green-600 text-sm font-semibold">
                    Proyecto 2
                </button>
                <% } %>
                <!-- Bot√≥n de estad√≠sticas -->
                <button onclick="toggleEstadisticas()" id="btn-stats" class="bg-yellow-700 hover:bg-yellow-800 px-4 py-2 rounded border border-yellow-600 text-sm font-semibold ml-4">
                    Estad√≠sticas
                </button>
            </div>
        </div>

        <!-- Panel de estad√≠sticas (oculto por defecto) -->
        <div id="panel-estadisticas" class="hidden mb-6">
            <div class="bg-gray-800 rounded-lg p-6 border border-gray-700">
                <h2 class="text-lg font-semibold mb-4 text-yellow-400">Estad√≠sticas del Proyecto</h2>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4" id="stats-container">
                    <!-- Se llenan din√°micamente -->
                </div>
            </div>
        </div>

        <!-- Contenedor principal -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            
            <!-- Panel principal - igual que miembro pero con vista completa -->
            <div class="lg:col-span-2">
                <div class="bg-gray-800 rounded-lg p-4 border border-gray-700">
                    <h2 class="text-lg font-semibold mb-4 text-yellow-400">
                        Mis Tareas Asignadas
                        <span id="proyecto-actual" class="text-sm text-gray-400">(GenT)</span>
                    </h2>
                    
                    <div id="mis-tareas" class="space-y-3 mb-6">
                        <!-- Las tareas se cargan din√°micamente -->
                        <div class="text-center py-8 text-gray-500">
                            <div class="text-4xl mb-2">üìù</div>
                            <p>Cargando tareas...</p>
                        </div>
                    </div>

                    <!-- Vista adicional: Todas las tareas del sprint -->
                    <div class="border-t border-gray-600 pt-4">
                        <h3 class="text-md font-semibold mb-3 text-blue-400">Todas las Tareas del Sprint</h3>
                        <div id="todas-tareas" class="space-y-2">
                            <!-- Se llenan din√°micamente -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Panel lateral -->
            <div class="space-y-4">
                
                <!-- Info del sprint -->
                <div class="bg-gray-800 rounded-lg p-4 border border-gray-700">
                    <h3 class="font-semibold mb-3 text-green-400">Sprint Actual</h3>
                    <div id="sprint-info" class="text-sm space-y-2">
                        <p>Sprint: <span id="sprint-numero">-</span></p>
                        <p>Inicio: <span id="sprint-inicio">-</span></p>
                        <p>Fin: <span id="sprint-fin">-</span></p>
                        <div class="mt-3 p-2 bg-gray-700 rounded">
                            <p class="text-xs">Progreso del sprint:</p>
                            <div class="w-full bg-gray-600 rounded-full h-2 mt-1">
                                <div id="progreso-bar" class="bg-green-500 h-2 rounded-full" style="width: 0%"></div>
                            </div>
                            <p class="text-xs mt-1"><span id="progreso-text">0%</span> completado</p>
                        </div>
                    </div>
                </div>

                <!-- Navegaci√≥n de sprints -->
                <div class="bg-gray-800 rounded-lg p-4 border border-gray-700">
                    <h3 class="font-semibold mb-3 text-blue-400">Ver Sprints</h3>
                    <div id="botones-sprints" class="grid grid-cols-2 gap-2">
                        <!-- Se llenan din√°micamente -->
                    </div>
                </div>

                <!-- Product Backlog -->
                <div class="bg-gray-800 rounded-lg p-4 border border-gray-700">
                    <h3 class="font-semibold mb-3 text-purple-400">Product Backlog</h3>
                    <div id="product-backlog" class="space-y-2 max-h-48 overflow-y-auto">
                        <!-- Se llena din√°micamente -->
                    </div>
                </div>

                <!-- Scrum Board simplificado -->
                <div class="bg-gray-800 rounded-lg p-4 border border-gray-700">
                    <h3 class="font-semibold mb-3 text-red-400">Scrum Board</h3>
                    <div id="scrum-board" class="space-y-2 text-sm">
                        <!-- Se llena din√°micamente -->
                    </div>
                </div>

            </div>
        </div>
    </div>

    <!-- Modal para cambiar estado de tarea -->
    <div id="modal-estado" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-gray-800 rounded-lg p-6 border border-gray-600 max-w-md w-full mx-4">
            <h3 class="text-lg font-semibold mb-4">Cambiar Estado de Tarea</h3>
            <div id="modal-content" class="mb-4">
                <!-- Contenido din√°mico -->
            </div>
            <div class="flex gap-2">
                <button id="btn-confirmar" class="flex-1 bg-green-600 hover:bg-green-700 px-4 py-2 rounded">
                    ‚úÖ Confirmar
                </button>
                <button onclick="cerrarModal()" class="bg-gray-600 hover:bg-gray-700 px-4 py-2 rounded">
                    ‚ùå Cancelar
                </button>
            </div>
        </div>
    </div>

    <script>
        let proyectoActual = 'GenT';
        let sprintActual = '1';
        let mostrandoEstadisticas = false;

        // Cambiar proyecto
        function cambiarProyecto(proyecto) {
            proyectoActual = proyecto;
            document.getElementById('proyecto-actual').textContent = `(${proyecto})`;
            
            // Actualizar botones
            document.querySelectorAll('[id^="btn-"]:not(#btn-stats)').forEach(btn => {
                btn.classList.remove('bg-yellow-600');
                btn.classList.add('bg-gray-700');
            });
            document.getElementById(`btn-${proyecto}`).classList.add('bg-yellow-600');
            
            cargarDatos();
        }

        // Toggle estad√≠sticas
        function toggleEstadisticas() {
            const panel = document.getElementById('panel-estadisticas');
            mostrandoEstadisticas = !mostrandoEstadisticas;
            
            if (mostrandoEstadisticas) {
                panel.classList.remove('hidden');
                cargarEstadisticas();
            } else {
                panel.classList.add('hidden');
            }
        }

        // Cargar estad√≠sticas
        async function cargarEstadisticas() {
            try {
                const response = await fetch(`/api/estadisticas/<%= grupo %>/${proyectoActual}`);
                const data = await response.json();
                
                const container = document.getElementById('stats-container');
                container.innerHTML = `
                    <div class="bg-blue-900 p-4 rounded border border-blue-700">
                        <h4 class="font-semibold text-blue-300">Proyecto</h4>
                        <p class="text-2xl font-bold">${data.proyecto.porcentajeCompletado}%</p>
                        <p class="text-sm text-blue-200">Completado</p>
                    </div>
                    <div class="bg-green-900 p-4 rounded border border-green-700">
                        <h4 class="font-semibold text-green-300">Tareas</h4>
                        <p class="text-2xl font-bold">${data.proyecto.tareasCompletadas}/${data.proyecto.totalTareas}</p>
                        <p class="text-sm text-green-200">Completadas</p>
                    </div>
                    <div class="bg-purple-900 p-4 rounded border border-purple-700">
                        <h4 class="font-semibold text-purple-300">Historias</h4>
                        <p class="text-2xl font-bold">${data.proyecto.historiasEnSprint}/${data.proyecto.totalHistorias}</p>
                        <p class="text-sm text-purple-200">En Sprint</p>
                    </div>
                `;
                
            } catch (error) {
                document.getElementById('stats-container').innerHTML = `
                    <div class="col-span-3 text-center text-red-400">
                        ‚ùå Error cargando estad√≠sticas
                    </div>
                `;
            }
        }

        // Cargar datos del proyecto/sprint
        async function cargarDatos() {
            try {
                await Promise.all([
                    cargarTareas(),
                    cargarTodasLasTareas(),
                    cargarSprintInfo(),
                    cargarProductBacklog(),
                    cargarBotonesSprints(),
                    cargarScrumBoard()
                ]);
            } catch (error) {
                console.error('Error cargando datos:', error);
            }
        }

        // Cargar todas las tareas del sprint (nueva funci√≥n para scrum master)
        async function cargarTodasLasTareas() {
            try {
                const response = await fetch(`/api/tareas/<%= grupo %>/${proyectoActual}/${sprintActual}`);
                const data = await response.json();
                
                const container = document.getElementById('todas-tareas');
                
                if (Object.keys(data.tareas).length === 0) {
                    container.innerHTML = `
                        <div class="text-center py-4 text-gray-500">
                            <p class="text-sm">No hay tareas en este sprint</p>
                        </div>
                    `;
                    return;
                }
                
                // Agrupar tareas por estado
                const tareasPorEstado = {
                    'POR_HACER': [],
                    'EN_PROCESO': [],
                    'COMPLETADO': [],
                    'VERIFICADO': []
                };
                
                Object.entries(data.tareas).forEach(([id, tarea]) => {
                    const [estado] = tarea;
                    if (tareasPorEstado[estado]) {
                        tareasPorEstado[estado].push([id, tarea]);
                    }
                });
                
                container.innerHTML = Object.entries(tareasPorEstado).map(([estado, tareas]) => {
                    if (tareas.length === 0) return '';
                    
                    const estadoColors = {
                        'POR_HACER': 'bg-gray-700 text-gray-300',
                        'EN_PROCESO': 'bg-yellow-700 text-yellow-300',
                        'COMPLETADO': 'bg-green-700 text-green-300',
                        'VERIFICADO': 'bg-blue-700 text-blue-300'
                    };
                    
                    return `
                        <div class="mb-3">
                            <h4 class="text-xs font-semibold ${estadoColors[estado]} px-2 py-1 rounded mb-2">
                                ${estado} (${tareas.length})
                            </h4>
                            <div class="space-y-1">
                                ${tareas.map(([id, tarea]) => {
                                    const [, descripcion, asignados] = tarea;
                                    return `
                                        <div class="bg-gray-700 p-2 rounded text-xs">
                                            <p class="font-medium">${descripcion.substring(0, 40)}...</p>
                                            <p class="text-gray-400">üë• ${asignados.join(', ')}</p>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        </div>
                    `;
                }).join('');
                
                // Calcular progreso
                const totalTareas = Object.keys(data.tareas).length;
                const tareasCompletadas = tareasPorEstado['COMPLETADO'].length + tareasPorEstado['VERIFICADO'].length;
                const porcentaje = totalTareas > 0 ? Math.round((tareasCompletadas / totalTareas) * 100) : 0;
                
                document.getElementById('progreso-bar').style.width = `${porcentaje}%`;
                document.getElementById('progreso-text').textContent = `${porcentaje}%`;
                
            } catch (error) {
                document.getElementById('todas-tareas').innerHTML = `
                    <div class="text-red-400 p-2 bg-red-900 rounded text-sm">
                        ‚ùå Error cargando tareas
                    </div>
                `;
            }
        }

        // Cargar scrum board simplificado
        async function cargarScrumBoard() {
            try {
                const response = await fetch(`/api/sprint/<%= grupo %>/${proyectoActual}/${sprintActual}`);
                const data = await response.json();
                
                const container = document.getElementById('scrum-board');
                
                if (!data.scrumBoard || data.scrumBoard.length === 0) {
                    container.innerHTML = '<p class="text-gray-500 text-sm">No hay historias seleccionadas</p>';
                    return;
                }
                
                container.innerHTML = data.scrumBoard.map(historiaId => `
                    <div class="bg-gray-700 p-2 rounded">
                        <p class="text-xs font-medium">${historiaId}</p>
                        <p class="text-xs text-gray-400">Historia en sprint</p>
                    </div>
                `).join('');
                
            } catch (error) {
                document.getElementById('scrum-board').innerHTML = `
                    <p class="text-red-400 text-sm">‚ùå Error cargando</p>
                `;
            }
        }

        // Reutilizar funciones del dashboard de miembro
        async function cargarTareas() {
            try {
                const response = await fetch(`/api/tareas/<%= grupo %>/${proyectoActual}/${sprintActual}`);
                const data = await response.json();
                
                const container = document.getElementById('mis-tareas');
                
                // Filtrar solo las tareas asignadas al usuario actual
                const misTareas = Object.entries(data.tareas).filter(([id, tarea]) => {
                    const [, , asignados] = tarea;
                    return asignados.includes('<%= user.nickname %>');
                });
                
                if (misTareas.length === 0) {
                    container.innerHTML = `
                        <div class="text-center py-4 text-gray-500">
                            <div class="text-2xl mb-1">üò¥</div>
                            <p class="text-sm">No tienes tareas asignadas</p>
                        </div>
                    `;
                    return;
                }
                
                container.innerHTML = misTareas.map(([id, tarea]) => {
                    const [estado, descripcion, asignados, prioridad, fechaLimite] = tarea;
                    const estadoColor = {
                        'POR_HACER': 'bg-gray-600',
                        'EN_PROCESO': 'bg-yellow-600',
                        'COMPLETADO': 'bg-green-600',
                        'VERIFICADO': 'bg-blue-600'
                    };
                    
                    return `
                        <div class="bg-yellow-900 border-2 border-yellow-600 rounded-lg p-3">
                            <div class="flex justify-between items-start mb-2">
                                <h4 class="font-semibold text-yellow-100 text-sm">${descripcion}</h4>
                                <span class="${estadoColor[estado] || 'bg-gray-600'} px-2 py-1 rounded text-xs">
                                    ${estado}
                                </span>
                            </div>
                            <p class="text-xs text-yellow-200 mb-2">
                                üö® ${prioridad} | üìÖ ${fechaLimite}
                            </p>
                            ${estado === 'POR_HACER' || estado === 'EN_PROCESO' ? `
                                <div class="flex gap-2">
                                    ${estado === 'POR_HACER' ? `
                                        <button onclick="cambiarEstadoTarea('${id}', 'EN_PROCESO')" 
                                                class="bg-yellow-600 hover:bg-yellow-700 px-2 py-1 rounded text-xs">
                                            ‚ñ∂Ô∏è Iniciar
                                        </button>
                                    ` : ''}
                                    ${estado === 'EN_PROCESO' ? `
                                        <button onclick="cambiarEstadoTarea('${id}', 'COMPLETADO')" 
                                                class="bg-green-600 hover:bg-green-700 px-2 py-1 rounded text-xs">
                                            ‚úÖ Completar
                                        </button>
                                    ` : ''}
                                </div>
                            ` : ''}
                        </div>
                    `;
                }).join('');
                
            } catch (error) {
                document.getElementById('mis-tareas').innerHTML = `
                    <div class="text-red-400 p-4 bg-red-900 rounded">
                        ‚ùå Error cargando tareas
                    </div>
                `;
            }
        }

        // Cargar info del sprint
        async function cargarSprintInfo() {
            try {
                const response = await fetch(`/api/sprint/<%= grupo %>/${proyectoActual}/${sprintActual}`);
                const data = await response.json();
                
                document.getElementById('sprint-numero').textContent = sprintActual;
                document.getElementById('sprint-inicio').textContent = data.fechaIni.join('/');
                document.getElementById('sprint-fin').textContent = data.fechaFin.join('/');
                
            } catch (error) {
                console.error('Error cargando sprint info:', error);
            }
        }

        // Cargar product backlog
        async function cargarProductBacklog() {
            try {
                const response = await fetch(`/api/product-backlog/<%= grupo %>/${proyectoActual}`);
                const data = await response.json();
                
                const container = document.getElementById('product-backlog');
                
                if (!data.productBacklog || data.productBacklog.length === 0) {
                    container.innerHTML = '<p class="text-gray-500 text-sm">No hay historias</p>';
                    return;
                }
                
                container.innerHTML = data.productBacklog.map(historia => {
                    const [id, como, quiero, para, criterio, prioridad, points, estado] = historia;
                    const estadoColor = {
                        'POR_HACER': 'text-gray-400',
                        'EN_SPRINT': 'text-yellow-400',
                        'COMPLETADO': 'text-green-400'
                    };
                    
                    return `
                        <div class="bg-gray-700 p-2 rounded text-sm">
                            <p class="font-semibold">${quiero}</p>
                            <p class="text-xs ${estadoColor[estado] || 'text-gray-400'}">
                                ${points} pts | ${estado} | ${prioridad}
                            </p>
                        </div>
                    `;
                }).join('');
                
            } catch (error) {
                document.getElementById('product-backlog').innerHTML = `
                    <p class="text-red-400 text-sm">‚ùå Error cargando</p>
                `;
            }
        }

        // Cargar botones de sprints
        async function cargarBotonesSprints() {
            document.getElementById('botones-sprints').innerHTML = `
                <button onclick="cambiarSprint('1')" 
                        class="bg-blue-600 hover:bg-blue-700 px-2 py-1 rounded text-sm ${sprintActual === '1' ? 'ring-2 ring-yellow-500' : ''}">
                    Sprint 1
                </button>
            `;
        }

        // Funciones de cambio de estado (iguales que miembro)
        function cambiarEstadoTarea(tareaId, nuevoEstado) {
            const modal = document.getElementById('modal-estado');
            const content = document.getElementById('modal-content');
            
            content.innerHTML = `
                <p class="mb-4">¬øCambiar estado a <strong>${nuevoEstado}</strong>?</p>
            `;
            
            document.getElementById('btn-confirmar').onclick = () => confirmarCambioEstado(tareaId, nuevoEstado);
            modal.classList.remove('hidden');
            modal.classList.add('flex');
        }

        async function confirmarCambioEstado(tareaId, nuevoEstado) {
            try {
                const response = await fetch(`/api/tareas/<%= grupo %>/${proyectoActual}/${tareaId}/estado`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ estado: nuevoEstado })
                });
                
                if (response.ok) {
                    cerrarModal();
                    cargarDatos(); // Recargar todos los datos
                } else {
                    alert('‚ùå Error cambiando estado');
                }
            } catch (error) {
                alert('‚ùå Error de conexi√≥n');
            }
        }

        function cerrarModal() {
            document.getElementById('modal-estado').classList.add('hidden');
            document.getElementById('modal-estado').classList.remove('flex');
        }

        function cambiarSprint(sprint) {
            sprintActual = sprint;
            cargarDatos();
        }

        // Cargar datos inicial
        document.addEventListener('DOMContentLoaded', () => {
            cargarDatos();
        });
    </script>
</body>
</html>